<div class="mb-2">
  <%= link_to "â† Back to League", league_path(@league), class: "btn btn-sm" %>
</div>

<div class="card mb-3">
  <h2 class="card-title"><%= @team.name %></h2>
  <%
    roster_config = @league.roster_config || {}
    total_roster_spots = roster_config.values.sum
    remaining_spots = total_roster_spots - @team.draft_picks.count
    max_bid = remaining_spots > 0 ? @team.budget_remaining - (remaining_spots - 1) : @team.budget_remaining
  %>
  <div class="grid grid-3">
    <div>
      <p class="text-sm text-muted">Budget Remaining</p>
      <p class="text-lg"><strong>$<%= @team.budget_remaining %></strong></p>
    </div>
    <div>
      <p class="text-sm text-muted">Budget Spent</p>
      <p class="text-lg">$<%= @league.auction_budget - @team.budget_remaining %></p>
    </div>
    <div>
      <p class="text-sm text-muted">Players Drafted</p>
      <p class="text-lg"><strong><%= @team.draft_picks.count %> / <%= total_roster_spots %></strong></p>
    </div>
    <div>
      <p class="text-sm text-muted">Max Bid</p>
      <p class="text-lg"><strong>$<%= max_bid %></strong></p>
    </div>
  </div>
</div>

<div class="card" data-controller="roster-move">
  <h3 class="card-title">Roster</h3>

  <%
    # Get roster configuration from league
    roster_config = @league.roster_config || {}

    # Group picks by position
    picks_by_position = @team.draft_picks.group_by(&:drafted_position)

    # Define position groups for display
    position_groups = [
      { name: "Batters", positions: ["C", "1B", "2B", "3B", "SS", "MI", "CI", "OF"] },
      { name: "Utility", positions: ["UTIL"] },
      { name: "Pitchers", positions: ["SP", "RP"] },
      { name: "Bench", positions: ["BENCH"] }
    ]
  %>

  <div id="roster-tables">
    <% position_groups.each do |group| %>
    <% group_has_positions = group[:positions].any? { |pos| roster_config[pos].to_i > 0 } %>
    <% if group_has_positions %>
      <div class="mb-4">
        <h4 class="text-base font-semibold mb-2 text-primary"><%= group[:name] %></h4>
        <table class="mb-0">
          <thead>
            <tr>
              <th style="width: 80px;">Position</th>
              <th>Player</th>
              <th>Price</th>
              <!-- Hitter Stats -->
              <th>HR</th>
              <th>R</th>
              <th>RBI</th>
              <th>SB</th>
              <th>AVG</th>
              <!-- Pitcher Stats -->
              <th>W</th>
              <th>SV</th>
              <th>K</th>
              <th>ERA</th>
              <th>WHIP</th>
            </tr>
          </thead>
          <tbody>
            <% group[:positions].each do |position| %>
              <% slot_count = roster_config[position].to_i %>
              <% next if slot_count == 0 %>

              <% slot_count.times do |slot_index| %>
                <% pick = picks_by_position[position]&.at(slot_index) %>
                <tr class="<%= pick ? '' : 'empty-slot' %>">
                  <% if pick %>
                    <td
                      class="position-cell clickable"
                      data-roster-move-target="positionCell"
                      data-action="click->roster-move#selectPlayer"
                      data-player-id="<%= pick.id %>"
                      data-current-position="<%= position %>"
                      data-player-positions="<%= pick.player.positions %>"
                      data-position="<%= position %>"
                      data-slot-index="<%= slot_index %>"
                    >
                      <strong><%= position %></strong>
                    </td>
                  <% else %>
                    <td
                      data-roster-move-target="positionCell"
                      data-position="<%= position %>"
                      data-slot-index="<%= slot_index %>"
                      data-player-id=""
                    >
                      <strong><%= position %></strong>
                    </td>
                  <% end %>
                  <% if pick %>
                    <td id="player-<%= pick.player.id %>">
                      <%= render partial: "players/player_name", locals: { player: pick.player } %>
                      <br>
                      <small class="text-muted"><%= pick.player.positions %> - <%= pick.player.mlb_team %></small>
                    </td>
                    <td><strong>$<%= pick.price %></strong></td>
                    <%= render "players/stats_columns", player: pick.player %>
                  <% else %>
                    <td colspan="12" class="text-muted">
                      <em>Empty Slot</em>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  <% end %>
  </div>
</div>
