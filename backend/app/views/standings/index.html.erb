<div class="mb-2">
  <%= link_to "← Back to League", league_path(@league), class: "btn btn-sm" %>
</div>

<%
  # Helper method to generate sort link
  def sort_link(column, label, current_sort, current_direction, league_id, bg_color = nil)
    # For total_points, default is asc (lower is better), otherwise desc
    default_direction = (column == 'total_points') ? 'asc' : 'desc'

    # Toggle direction based on current state
    if current_sort == column.to_s
      direction = (current_direction == 'desc') ? 'asc' : 'desc'
    else
      direction = default_direction
    end

    arrow = if current_sort == column.to_s
      current_direction == 'asc' ? ' ↑' : ' ↓'
    else
      ''
    end

    link_params = { sort: column, direction: direction }

    style = bg_color ? "background-color: #{bg_color};" : ""
    link_to "#{label}#{arrow}", league_standings_path(league_id, link_params), class: 'sort-link', style: style
  end

  current_sort = params[:sort]
  current_direction = params[:direction]
%>

<div class="card">
  <h3 class="card-title">League Standings</h3>
  <p class="text-muted mb-3"><%= @league.name %> - Rotisserie Scoring</p>

  <div style="overflow-x: auto;">
    <table>
      <thead>
        <tr>
          <th rowspan="2">Team</th>
          <th rowspan="2"><%= sort_link('total_points', 'Total Points', current_sort, current_direction, @league.id) %></th>
          <th colspan="6" style="text-align: center; background-color: #f0f8ff; border-bottom: 2px solid #4a90e2;">Batting</th>
          <th colspan="6" style="text-align: center; background-color: #fff5f0; border-bottom: 2px solid #e2994a;">Pitching</th>
        </tr>
        <tr>
          <!-- Hitter Categories -->
          <th><%= sort_link('home_runs', 'HR', current_sort, current_direction, @league.id, '#f0f8ff') %></th>
          <th><%= sort_link('runs', 'R', current_sort, current_direction, @league.id, '#f0f8ff') %></th>
          <th><%= sort_link('rbi', 'RBI', current_sort, current_direction, @league.id, '#f0f8ff') %></th>
          <th><%= sort_link('stolen_bases', 'SB', current_sort, current_direction, @league.id, '#f0f8ff') %></th>
          <th><%= sort_link('batting_average', 'AVG', current_sort, current_direction, @league.id, '#f0f8ff') %></th>
          <th><%= sort_link('at_bats', 'AB', current_sort, current_direction, @league.id, '#f0f8ff') %></th>
          <!-- Pitcher Categories -->
          <th><%= sort_link('wins', 'W', current_sort, current_direction, @league.id, '#fff5f0') %></th>
          <th><%= sort_link('saves', 'SV', current_sort, current_direction, @league.id, '#fff5f0') %></th>
          <th><%= sort_link('strikeouts', 'K', current_sort, current_direction, @league.id, '#fff5f0') %></th>
          <th><%= sort_link('era', 'ERA', current_sort, current_direction, @league.id, '#fff5f0') %></th>
          <th><%= sort_link('whip', 'WHIP', current_sort, current_direction, @league.id, '#fff5f0') %></th>
          <th><%= sort_link('innings_pitched', 'IP', current_sort, current_direction, @league.id, '#fff5f0') %></th>
        </tr>
      </thead>
      <tbody>
        <% @team_stats.each do |team_stat| %>
          <% team = team_stat[:team] %>
          <% stats = team_stat[:stats] %>
          <% ranks = @rankings[team.id] %>
          <tr>
            <td><strong><%= link_to team.name, team_path(team) %></strong></td>
            <td><strong><%= ranks[:total_points] %></strong></td>

            <!-- Hitter Stats with Ranks -->
            <td style="background-color: #f0f8ff;">
              <%= stats[:home_runs].round(1) %>
              <span class="text-muted" style="font-size: 0.9em;">(#<%= ranks[:home_runs] %>)</span>
            </td>
            <td style="background-color: #f0f8ff;">
              <%= stats[:runs].round(1) %>
              <span class="text-muted" style="font-size: 0.9em;">(#<%= ranks[:runs] %>)</span>
            </td>
            <td style="background-color: #f0f8ff;">
              <%= stats[:rbi].round(1) %>
              <span class="text-muted" style="font-size: 0.9em;">(#<%= ranks[:rbi] %>)</span>
            </td>
            <td style="background-color: #f0f8ff;">
              <%= stats[:stolen_bases].round(1) %>
              <span class="text-muted" style="font-size: 0.9em;">(#<%= ranks[:stolen_bases] %>)</span>
            </td>
            <td style="background-color: #f0f8ff;">
              <%= stats[:batting_average] == 0.0 ? "-" : stats[:batting_average].round(3) %>
              <span class="text-muted" style="font-size: 0.9em;"><% if stats[:batting_average] > 0 %>(#<%= ranks[:batting_average] %>)<% end %></span>
            </td>
            <td class="text-muted" style="background-color: #f0f8ff;">
              <%= stats[:at_bats].round(0) %>
            </td>

            <!-- Pitcher Stats with Ranks -->
            <td style="background-color: #fff5f0;">
              <%= stats[:wins].round(1) %>
              <span class="text-muted" style="font-size: 0.9em;">(#<%= ranks[:wins] %>)</span>
            </td>
            <td style="background-color: #fff5f0;">
              <%= stats[:saves].round(1) %>
              <span class="text-muted" style="font-size: 0.9em;">(#<%= ranks[:saves] %>)</span>
            </td>
            <td style="background-color: #fff5f0;">
              <%= stats[:strikeouts].round(1) %>
              <span class="text-muted" style="font-size: 0.9em;">(#<%= ranks[:strikeouts] %>)</span>
            </td>
            <td style="background-color: #fff5f0;">
              <%= stats[:era] == 0.0 ? "-" : stats[:era].round(2) %>
              <span class="text-muted" style="font-size: 0.9em;"><% if stats[:era] > 0 %>(#<%= ranks[:era] %>)<% end %></span>
            </td>
            <td style="background-color: #fff5f0;">
              <%= stats[:whip] == 0.0 ? "-" : stats[:whip].round(3) %>
              <span class="text-muted" style="font-size: 0.9em;"><% if stats[:whip] > 0 %>(#<%= ranks[:whip] %>)<% end %></span>
            </td>
            <td class="text-muted" style="background-color: #fff5f0;">
              <%= stats[:innings_pitched].round(1) %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="mt-3 text-muted">
    <p><strong>Scoring:</strong> Rotisserie format - teams are ranked 1st through Nth in each category. Total points is the sum of all category ranks. Lower total points is better.</p>
    <p><strong>Categories:</strong></p>
    <ul>
      <li><strong>Hitters:</strong> HR (Home Runs), R (Runs), RBI (Runs Batted In), SB (Stolen Bases), AVG (Batting Average - weighted by AB), AB (Total At-Bats)</li>
      <li><strong>Pitchers:</strong> W (Wins), SV (Saves), K (Strikeouts), ERA (Earned Run Average - weighted by IP), WHIP (Walks + Hits per IP - weighted by IP), IP (Total Innings Pitched)</li>
    </ul>
    <p><strong>Note:</strong> Rate stats (AVG, ERA, WHIP) are calculated as weighted averages based on each player's AB or IP. The AB and IP columns show the total weights used in these calculations.</p>
  </div>
</div>
