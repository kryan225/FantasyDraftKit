<div class="mb-2">
  <%= link_to "← Back to League", league_path(@league), class: "btn btn-sm" %>
</div>

<%
  # Helper method to generate sort link
  def sort_link(column, label, current_sort, current_direction, league_id, bg_color = nil)
    # Default is desc for all columns (higher is better with inverted scoring)
    default_direction = 'desc'

    # Toggle direction based on current state
    if current_sort == column.to_s
      direction = (current_direction == 'desc') ? 'asc' : 'desc'
    else
      direction = default_direction
    end

    arrow = if current_sort == column.to_s
      current_direction == 'asc' ? ' ↑' : ' ↓'
    else
      ''
    end

    link_params = { sort: column, direction: direction }

    style = bg_color ? "background-color: #{bg_color};" : ""
    link_to "#{label}#{arrow}", league_standings_path(league_id, link_params), class: 'sort-link', style: style
  end

  current_sort = params[:sort]
  current_direction = params[:direction]

  # Helper method to generate heatmap color based on rank
  def heatmap_color(rank, num_teams)
    return "background-color: #f5f5f5;" if rank.nil?  # Gray for missing values

    # Calculate percentage: 0% = best (rank 1), 100% = worst (rank = num_teams)
    percentage = (rank - 1).to_f / [num_teams - 1, 1].max

    # Color gradient: Green (best) → Yellow (middle) → Red (worst)
    if percentage <= 0.5
      # Green to Yellow
      r = (255 * (percentage * 2)).to_i
      g = 200
      b = 50
    else
      # Yellow to Red
      r = 255
      g = (200 * (1 - (percentage - 0.5) * 2)).to_i
      b = 50
    end

    "background-color: rgb(#{r}, #{g}, #{b}); color: #{percentage > 0.6 ? 'white' : 'black'};"
  end

  num_teams = @team_stats.size
%>

<div class="card">
  <h3 class="card-title">League Standings</h3>
  <p class="text-muted mb-3"><%= @league.name %> - Rotisserie Scoring</p>

  <div style="overflow-x: auto;">
    <table>
      <thead>
        <tr>
          <th rowspan="2">Team</th>
          <th rowspan="2"><%= sort_link('total_points', 'Total Points', current_sort, current_direction, @league.id) %></th>
          <th colspan="6" style="text-align: center; background-color: #f0f8ff; border-bottom: 2px solid #4a90e2;">Batting</th>
          <th colspan="6" style="text-align: center; background-color: #fff5f0; border-bottom: 2px solid #e2994a;">Pitching</th>
        </tr>
        <tr>
          <!-- Hitter Categories -->
          <th><%= sort_link('home_runs', 'HR', current_sort, current_direction, @league.id, '#f0f8ff') %></th>
          <th><%= sort_link('runs', 'R', current_sort, current_direction, @league.id, '#f0f8ff') %></th>
          <th><%= sort_link('rbi', 'RBI', current_sort, current_direction, @league.id, '#f0f8ff') %></th>
          <th><%= sort_link('stolen_bases', 'SB', current_sort, current_direction, @league.id, '#f0f8ff') %></th>
          <th><%= sort_link('batting_average', 'AVG', current_sort, current_direction, @league.id, '#f0f8ff') %></th>
          <th><%= sort_link('at_bats', 'AB', current_sort, current_direction, @league.id, '#f0f8ff') %></th>
          <!-- Pitcher Categories -->
          <th><%= sort_link('wins', 'W', current_sort, current_direction, @league.id, '#fff5f0') %></th>
          <th><%= sort_link('saves', 'SV', current_sort, current_direction, @league.id, '#fff5f0') %></th>
          <th><%= sort_link('strikeouts', 'K', current_sort, current_direction, @league.id, '#fff5f0') %></th>
          <th><%= sort_link('era', 'ERA', current_sort, current_direction, @league.id, '#fff5f0') %></th>
          <th><%= sort_link('whip', 'WHIP', current_sort, current_direction, @league.id, '#fff5f0') %></th>
          <th><%= sort_link('innings_pitched', 'IP', current_sort, current_direction, @league.id, '#fff5f0') %></th>
        </tr>
      </thead>
      <tbody>
        <% @team_stats.each do |team_stat| %>
          <% team = team_stat[:team] %>
          <% stats = team_stat[:stats] %>
          <% ranks = @rankings[team.id] %>
          <tr>
            <td><strong><%= link_to team.name, team_path(team) %></strong></td>
            <td>
              <strong><%= ranks[:total_points] %></strong>
              <span class="text-muted" style="font-size: 0.9em;">(#<%= ranks[:total_points_rank] %>)</span>
            </td>

            <!-- Hitter Stats with Ranks -->
            <td style="<%= heatmap_color(ranks[:home_runs], num_teams) %>">
              <%= stats[:home_runs].round(1) %>
              <span style="font-size: 0.9em; opacity: 0.8;">(#<%= ranks[:home_runs] %>)</span>
            </td>
            <td style="<%= heatmap_color(ranks[:runs], num_teams) %>">
              <%= stats[:runs].round(1) %>
              <span style="font-size: 0.9em; opacity: 0.8;">(#<%= ranks[:runs] %>)</span>
            </td>
            <td style="<%= heatmap_color(ranks[:rbi], num_teams) %>">
              <%= stats[:rbi].round(1) %>
              <span style="font-size: 0.9em; opacity: 0.8;">(#<%= ranks[:rbi] %>)</span>
            </td>
            <td style="<%= heatmap_color(ranks[:stolen_bases], num_teams) %>">
              <%= stats[:stolen_bases].round(1) %>
              <span style="font-size: 0.9em; opacity: 0.8;">(#<%= ranks[:stolen_bases] %>)</span>
            </td>
            <td style="<%= heatmap_color(ranks[:batting_average], num_teams) %>">
              <%= stats[:batting_average] == 0.0 ? "-" : stats[:batting_average].round(3) %>
              <span style="font-size: 0.9em; opacity: 0.8;"><% if stats[:batting_average] > 0 %>(#<%= ranks[:batting_average] %>)<% end %></span>
            </td>
            <td style="<%= heatmap_color(ranks[:at_bats], num_teams) %>">
              <%= stats[:at_bats].round(0) %>
              <span style="font-size: 0.9em; opacity: 0.8;">(#<%= ranks[:at_bats] %>)</span>
            </td>

            <!-- Pitcher Stats with Ranks -->
            <td style="<%= heatmap_color(ranks[:wins], num_teams) %>">
              <%= stats[:wins].round(1) %>
              <span style="font-size: 0.9em; opacity: 0.8;">(#<%= ranks[:wins] %>)</span>
            </td>
            <td style="<%= heatmap_color(ranks[:saves], num_teams) %>">
              <%= stats[:saves].round(1) %>
              <span style="font-size: 0.9em; opacity: 0.8;">(#<%= ranks[:saves] %>)</span>
            </td>
            <td style="<%= heatmap_color(ranks[:strikeouts], num_teams) %>">
              <%= stats[:strikeouts].round(1) %>
              <span style="font-size: 0.9em; opacity: 0.8;">(#<%= ranks[:strikeouts] %>)</span>
            </td>
            <td style="<%= heatmap_color(ranks[:era], num_teams) %>">
              <%= stats[:era] == 0.0 ? "-" : stats[:era].round(2) %>
              <span style="font-size: 0.9em; opacity: 0.8;"><% if stats[:era] > 0 %>(#<%= ranks[:era] %>)<% end %></span>
            </td>
            <td style="<%= heatmap_color(ranks[:whip], num_teams) %>">
              <%= stats[:whip] == 0.0 ? "-" : stats[:whip].round(3) %>
              <span style="font-size: 0.9em; opacity: 0.8;"><% if stats[:whip] > 0 %>(#<%= ranks[:whip] %>)<% end %></span>
            </td>
            <td style="<%= heatmap_color(ranks[:innings_pitched], num_teams) %>">
              <%= stats[:innings_pitched].round(1) %>
              <span style="font-size: 0.9em; opacity: 0.8;">(#<%= ranks[:innings_pitched] %>)</span>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="mt-3 text-muted">
    <p><strong>Scoring:</strong> Rotisserie format with inverted scoring. Teams are ranked 1st through Nth in each of 10 categories. Points are awarded: 1st place = N points, 2nd place = (N-1) points, etc. Higher total points is better.</p>
    <p><strong>Heatmap Visualization:</strong> Cell colors indicate rank performance - <span style="background-color: rgb(50, 200, 50); padding: 2px 8px; border-radius: 3px; color: white;">Green = Best</span> <span style="background-color: rgb(255, 200, 50); padding: 2px 8px; border-radius: 3px;">Yellow = Middle</span> <span style="background-color: rgb(255, 100, 50); padding: 2px 8px; border-radius: 3px; color: white;">Red = Worst</span></p>
    <p><strong>Scored Categories (10):</strong></p>
    <ul>
      <li><strong>Hitters (5):</strong> HR (Home Runs), R (Runs), RBI (Runs Batted In), SB (Stolen Bases), AVG (Batting Average - weighted by AB)</li>
      <li><strong>Pitchers (5):</strong> W (Wins), SV (Saves), K (Strikeouts), ERA (Earned Run Average - weighted by IP), WHIP (Walks + Hits per IP - weighted by IP)</li>
    </ul>
    <p><strong>Volume Metrics (not scored):</strong> AB (At-Bats) and IP (Innings Pitched) are ranked for reference but do NOT contribute to Total Points.</p>
    <p><strong>Note:</strong> Rate stats (AVG, ERA, WHIP) are calculated as weighted averages based on each player's AB or IP.</p>
  </div>
</div>
